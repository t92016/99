<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸å­¸ä¹˜æ³•å°„æ“ŠéŠæˆ²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        body { font-family: 'Inter', sans-serif; }
        /* éŠæˆ²å®¹å™¨ç½®ä¸­ */
        .game-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #1a1a2e; /* æ·±å¤ªç©ºèƒŒæ™¯ */
            border: 4px solid #4ade80; /* äº®ç¶ è‰²é‚Šæ¡† */
            box-shadow: 0 0 20px rgba(74, 203, 114, 0.5);
            border-radius: 12px;
            overflow: hidden;
        }
        canvas {
            display: block;
            width: 100%;
            height: auto;
            background-color: #0d0d18;
        }
        /* æŒ‰éˆ•åŸºç¤æ¨£å¼ (å¯æ„›é¢¨æ ¼) */
        .game-btn {
            background-color: #fca5a5; /* æŸ”å’Œçš„ç²‰ç´…è‰² */
            color: #440000;
            font-weight: bold;
            border: 3px solid #ef4444;
            transition: transform 0.1s;
            box-shadow: 0 4px 0 #ef4444;
        }
        .game-btn:hover {
            background-color: #fecaca;
        }
        .game-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #ef4444;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen p-4 flex flex-col items-center">

    <h1 class="text-4xl font-extrabold text-white mb-6 text-center tracking-wider">
        ğŸš€ æ•¸å­¸å°„æ“ŠæŒ‘æˆ° (2x2)
    </h1>

    <div id="game-ui" class="game-container w-full">
        <!-- éŠæˆ²è³‡è¨Šé¢æ¿ -->
        <div class="flex justify-between items-center p-3 bg-gray-800 text-white font-mono text-xl md:text-2xl">
            <div class="flex items-center space-x-2">
                <span class="text-red-400">â¤ï¸</span>
                <span id="lives-display" class="font-bold">3</span>
            </div>
            <div id="problem-display" class="text-yellow-300 font-extrabold text-3xl md:text-5xl tracking-widest">
                -- Ã— --
            </div>
            <div class="flex items-center space-x-2">
                <span class="text-green-400">ğŸŒŸ</span>
                <span id="score-display" class="font-bold">0</span>
            </div>
        </div>

        <!-- éŠæˆ²ç•«å¸ƒ -->
        <canvas id="gameCanvas" width="800" height="600" class="cursor-pointer"></canvas>

        <!-- é–‹å§‹ç•«é¢/çµæŸç•«é¢ -->
        <div id="start-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-black bg-opacity-70 z-10 hidden" style="height: 600px; max-width: 800px; margin: auto;">
            <h2 id="screen-title" class="text-6xl font-black text-yellow-400 mb-6 animate-pulse">æ•¸å­¸å°„æ“ŠéŠæˆ²</h2>
            <p id="screen-message" class="text-white text-xl mb-8 text-center px-4">
                ç›®æ¨™ï¼šå°„æ“Šæ­£ç¢ºç­”æ¡ˆçš„å°è¡Œæ˜Ÿï¼<br>
                æ§åˆ¶ï¼šéµç›¤â† â†’ æˆ– A D ç§»å‹•ï¼Œç©ºç™½éµç™¼å°„ã€‚<br>
                è¡Œå‹•è£ç½®è«‹ä½¿ç”¨ä¸‹æ–¹çš„æŒ‰éˆ•ã€‚
            </p>
            <button id="start-button" class="game-btn px-10 py-4 text-3xl rounded-full hover:bg-red-300 transition duration-150">
                é–‹å§‹éŠæˆ²
            </button>
        </div>
    </div>

    <!-- è¡Œå‹•è£ç½®æ§åˆ¶é¢æ¿ (åœ¨å°å‹è¢å¹•ä¸Šé¡¯ç¤º) -->
    <div class="md:hidden w-full max-w-lg mt-6 p-4 bg-gray-800 rounded-xl shadow-2xl">
        <h3 class="text-white text-lg font-semibold mb-3 text-center">è¡Œå‹•è£ç½®æ§åˆ¶</h3>
        <div class="flex justify-around items-center">
            <button id="mobile-left" class="game-btn w-20 h-20 text-4xl rounded-xl">
                &lt;
            </button>
            <button id="mobile-shoot" class="game-btn w-24 h-24 text-4xl rounded-full bg-blue-400 border-blue-600 shadow-blue-600 hover:bg-blue-300 active:shadow-blue-600" style="color:white; box-shadow: 0 4px 0 #2563eb;">
                FIRE
            </button>
            <button id="mobile-right" class="game-btn w-20 h-20 text-4xl rounded-xl">
                &gt;
            </button>
        </div>
    </div>

    <script type="module">
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const startButton = document.getElementById('start-button');
        const problemDisplay = document.getElementById('problem-display');
        const scoreDisplay = document.getElementById('score-display');
        const livesDisplay = document.getElementById('lives-display');
        const screenTitle = document.getElementById('screen-title');
        const screenMessage = document.getElementById('screen-message');
        
        // è¡Œå‹•è£ç½®æŒ‰éˆ•
        const mobileLeft = document.getElementById('mobile-left');
        const mobileRight = document.getElementById('mobile-right');
        const mobileShoot = document.getElementById('mobile-shoot');

        // éŠæˆ²å¸¸æ•¸
        const CANVAS_WIDTH = 800;
        const CANVAS_HEIGHT = 600;
        const PLAYER_SIZE = 40;
        const BULLET_SPEED = 8;
        const ASTEROID_RADIUS = 30;
        const MAX_ASTEROIDS = 3;
        
        // éŠæˆ²ç‹€æ…‹
        let gameState = 'ready'; // ready, playing, gameover
        let score = 0;
        let lives = 3;
        let player = { x: CANVAS_WIDTH / 2, speed: 7, movingLeft: false, movingRight: false };
        let bullets = [];
        let asteroids = [];
        let currentProblem = null;
        let lastUpdateTime = 0;
        const TARGET_INTERVAL = 2000; // æ¯ 2 ç§’ç”Ÿæˆä¸€çµ„å°è¡Œæ˜Ÿ

        // --- æ•¸å­¸é‚è¼¯ ---

        /**
         * ç”Ÿæˆä¸€å€‹ 2 ä½æ•¸ * 2 ä½æ•¸çš„ä¹˜æ³•å•é¡ŒåŠå…¶ç­”æ¡ˆé¸é …
         */
        function generateProblem() {
            const num1 = Math.floor(Math.random() * 90) + 10; // 10 to 99
            const num2 = Math.floor(Math.random() * 90) + 10; // 10 to 99
            const correctAnswer = num1 * num2;

            // ç”Ÿæˆå…©å€‹ä¸æ­£ç¢ºä½†åˆç†çš„ç­”æ¡ˆï¼ˆåˆ†å¿ƒç‰©ï¼‰
            let distractor1, distractor2;
            const variation = [1, -1, 10, -10, 100, -100];
            
            do {
                const index1 = Math.floor(Math.random() * variation.length);
                const offset1 = (Math.floor(Math.random() * 5) + 1);
                distractor1 = correctAnswer + variation[index1] * offset1;
                distractor1 = Math.max(100, distractor1); 

                const index2 = Math.floor(Math.random() * variation.length);
                const offset2 = (Math.floor(Math.random() * 5) + 1);
                distractor2 = correctAnswer + variation[index2] * offset2;
                distractor2 = Math.max(100, distractor2);
            } while (distractor1 === correctAnswer || distractor2 === correctAnswer || distractor1 === distractor2);

            const answers = [
                { value: correctAnswer, isCorrect: true },
                { value: distractor1, isCorrect: false },
                { value: distractor2, isCorrect: false }
            ];

            // æ‰“äº‚ç­”æ¡ˆçš„é †åº
            for (let i = answers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [answers[i], answers[j]] = [answers[j], answers[i]];
            }

            return { num1, num2, correctAnswer, answers };
        }

        // --- ç¹ªåœ–é‚è¼¯ (å¯æ„›é¢¨æ ¼) ---

        /**
         * ç¹ªè£½ç©å®¶é£›èˆ¹ (å¯æ„›çš„åœ“å½¢é£›èˆ¹)
         */
        function drawPlayer() {
            ctx.fillStyle = '#4ade80'; // ç¶ è‰²é£›èˆ¹
            ctx.beginPath();
            // ä¸»é«”ï¼šåœ“å½¢
            ctx.arc(player.x, CANVAS_HEIGHT - 30, PLAYER_SIZE / 2, Math.PI, 2 * Math.PI); 
            ctx.fill();

            // é§•é§›è‰™ï¼šå°åœ“å½¢
            ctx.fillStyle = '#fef08a'; // é»ƒè‰²
            ctx.beginPath();
            ctx.arc(player.x, CANVAS_HEIGHT - 30, PLAYER_SIZE / 4, Math.PI, 2 * Math.PI);
            ctx.fill();

            // æ¨é€²å™¨ç«ç„° (ç°¡å–®ä¸‰è§’å½¢)
            ctx.fillStyle = '#f97316'; 
            ctx.beginPath();
            ctx.moveTo(player.x - 10, CANVAS_HEIGHT - 30);
            ctx.lineTo(player.x + 10, CANVAS_HEIGHT - 30);
            ctx.lineTo(player.x, CANVAS_HEIGHT - 20);
            ctx.fill();
        }

        /**
         * ç¹ªè£½å­å½ˆ
         */
        function drawBullet(bullet) {
            ctx.fillStyle = '#facc15'; // äº®é»ƒè‰²å­å½ˆ
            ctx.beginPath();
            ctx.arc(bullet.x, bullet.y, 4, 0, Math.PI * 2);
            ctx.fill();
        }

        /**
         * ç¹ªè£½å°è¡Œæ˜Ÿ (åœ“å½¢ï¼Œå¸¶æœ‰æ•¸å­—)
         */
        function drawAsteroid(asteroid) {
            // å°è¡Œæ˜Ÿæœ¬é«” (å¯æ„›çš„å²©çŸ³/æ˜Ÿçƒ)
            ctx.fillStyle = asteroid.isCorrect ? '#60a5fa' : '#ef4444'; // æ­£ç¢ºç­”æ¡ˆæ˜¯è—è‰²ï¼ŒéŒ¯èª¤æ˜¯ç´…è‰²
            ctx.beginPath();
            ctx.arc(asteroid.x, asteroid.y, ASTEROID_RADIUS, 0, Math.PI * 2);
            ctx.fill();

            // é‚Šç·£å…‰æšˆ (è®“å®ƒæ›´å¯æ„›/çªå‡º)
            ctx.strokeStyle = asteroid.isCorrect ? '#3b82f6' : '#b91c1c';
            ctx.lineWidth = 3;
            ctx.stroke();

            // å°è¡Œæ˜Ÿä¸Šçš„æ•¸å­—
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 18px Inter';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(asteroid.value, asteroid.x, asteroid.y);
        }
        
        // --- éŠæˆ²é‚è¼¯ ---

        function initGame() {
            score = 0;
            lives = 3;
            player.x = CANVAS_WIDTH / 2;
            bullets = [];
            asteroids = [];
            currentProblem = generateProblem();
            gameState = 'playing';
            lastUpdateTime = performance.now();
            
            // ç¢ºä¿ Start Screen è¢«éš±è—
            startScreen.classList.add('hidden');
            
            updateUI();
            gameLoop();
        }

        function updateUI() {
            problemDisplay.textContent = `${currentProblem.num1} Ã— ${currentProblem.num2}`;
            scoreDisplay.textContent = score;
            livesDisplay.textContent = lives;
            if (lives <= 0) {
                // å¦‚æœç”Ÿå‘½è€—ç›¡ï¼Œå°‡é¡¯ç¤ºè¨­ç‚º 0ï¼Œé¿å…è² æ•¸
                livesDisplay.textContent = 0;
            }
        }

        /**
         * ç”¢ç”Ÿä¸€çµ„æ–°çš„å°è¡Œæ˜Ÿ
         */
        function spawnAsteroids() {
            if (!currentProblem) return;

            const gap = CANVAS_WIDTH / (MAX_ASTEROIDS + 1); // ç¢ºä¿å‡å‹»åˆ†ä½ˆ
            
            currentProblem.answers.forEach((answer, index) => {
                const xPos = gap * (index + 1);
                const speed = 0.5 + Math.random() * 0.5; // é€Ÿåº¦è®ŠåŒ–ï¼Œå¢åŠ è¶£å‘³
                
                asteroids.push({
                    x: xPos,
                    y: -ASTEROID_RADIUS, // å¾ç•«å¸ƒä¸Šæ–¹å¤–é–‹å§‹
                    value: answer.value,
                    isCorrect: answer.isCorrect,
                    radius: ASTEROID_RADIUS,
                    dy: speed,
                });
            });
        }

        /**
         * è™•ç†ç©å®¶è¼¸å…¥
         */
        function handleInput() {
            if (player.movingLeft) {
                player.x = Math.max(PLAYER_SIZE / 2, player.x - player.speed);
            }
            if (player.movingRight) {
                player.x = Math.min(CANVAS_WIDTH - PLAYER_SIZE / 2, player.x + player.speed);
            }
        }

        /**
         * è™•ç†éŠæˆ²ç‰©ä»¶çš„ç§»å‹•
         */
        function updateObjects() {
            // 1. æ›´æ–°å­å½ˆä½ç½®
            bullets.forEach(bullet => {
                bullet.y -= BULLET_SPEED;
            });
            bullets = bullets.filter(bullet => bullet.y > 0);

            // 2. æ›´æ–°å°è¡Œæ˜Ÿä½ç½®
            asteroids.forEach(asteroid => {
                asteroid.y += asteroid.dy;
            });
            
            // æª¢æŸ¥å°è¡Œæ˜Ÿæ˜¯å¦è¶Šç•Œ
            asteroids.filter(asteroid => asteroid.y > CANVAS_HEIGHT + ASTEROID_RADIUS).forEach(asteroid => {
                if (asteroid.isCorrect) {
                    // æ­£ç¢ºç­”æ¡ˆæ¼æ‰ï¼Œæ‰£ç”Ÿå‘½
                    lives--;
                    updateUI();
                    if (lives <= 0) {
                        endGame(false);
                    } else {
                        // æç¤ºç©å®¶
                        showMessage('âš ï¸ æ¼æ‰æ­£ç¢ºç­”æ¡ˆï¼ -1 ç”Ÿå‘½', '#ff4d4d'); 
                        resetProblem();
                    }
                } else {
                    // éŒ¯èª¤ç­”æ¡ˆæ¼æ‰ï¼Œç„¡æ‡²ç½°
                    showMessage('âœ¨ é¿å…éŒ¯èª¤ç­”æ¡ˆï¼', '#66ff99'); 
                }
            });
            // ç§»é™¤è¶Šç•Œçš„å°è¡Œæ˜Ÿ
            asteroids = asteroids.filter(asteroid => asteroid.y <= CANVAS_HEIGHT + ASTEROID_RADIUS);
        }
        
        /**
         * é‡è¨­å•é¡Œï¼Œä¸¦æ¸…é™¤æ‰€æœ‰å ´ä¸Šå°è¡Œæ˜Ÿ
         */
        function resetProblem() {
            asteroids = [];
            currentProblem = generateProblem();
            updateUI();
        }

        /**
         * è™•ç†ç¢°æ’åµæ¸¬
         */
        function checkCollisions() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                for (let j = asteroids.length - 1; j >= 0; j--) {
                    const asteroid = asteroids[j];

                    // ç°¡æ˜“åœ“å½¢ç¢°æ’åµæ¸¬
                    const dx = bullet.x - asteroid.x;
                    const dy = bullet.y - asteroid.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < asteroid.radius + 4) { // 4 æ˜¯å­å½ˆåŠå¾‘
                        // ç¢°æ’ç™¼ç”Ÿ
                        bullets.splice(i, 1); // ç§»é™¤å­å½ˆ
                        
                        if (asteroid.isCorrect) {
                            score += 10;
                            showMessage('ğŸ‰ ç­”å°äº†! +10 åˆ†', '#4ade80');
                        } else {
                            score = Math.max(0, score - 5); // å°„ä¸­éŒ¯èª¤ç­”æ¡ˆï¼Œå°æ‰£åˆ†
                            showMessage('âŒ éŒ¯èª¤ç­”æ¡ˆ! -5 åˆ†', '#ff4d4d');
                        }
                        
                        asteroids.splice(j, 1); // ç§»é™¤å°è¡Œæ˜Ÿ
                        updateUI();
                        
                        // ç•¶æ‰€æœ‰å°è¡Œæ˜Ÿéƒ½è¢«ç§»é™¤å¾Œï¼Œç”Ÿæˆæ–°å•é¡Œ
                        if (asteroids.length === 0) {
                            resetProblem();
                        }
                        
                        // è·³å‡ºå…§å±¤å¾ªç’°ï¼Œå› ç‚ºå­å½ˆå·²ç¶“è¢«éŠ·æ¯€
                        break; 
                    }
                }
            }
        }

        /**
         * çµæŸéŠæˆ²ç•«é¢
         */
        function endGame(isWin) {
            gameState = 'gameover';
            screenTitle.textContent = isWin ? 'éŠæˆ²å‹åˆ©ï¼' : 'éŠæˆ²çµæŸ ğŸ˜­';
            screenMessage.innerHTML = `æ‚¨çš„æœ€çµ‚å¾—åˆ†: <span class="text-yellow-400 font-bold">${score}</span> åˆ†ï¼<br>
                                        æ‚¨èƒ½æŒ‘æˆ°æ›´é«˜çš„åˆ†æ•¸å—ï¼Ÿ`;
            startButton.textContent = 'é‡æ–°é–‹å§‹';
            startScreen.classList.remove('hidden');
        }
        
        /**
         * é¡¯ç¤ºçŸ­æš«çš„éŠæˆ²è¨Šæ¯
         */
        let messageTimer = null;
        function showMessage(text, color) {
            if (messageTimer) {
                clearTimeout(messageTimer);
            }
            const tempDiv = document.createElement('div');
            tempDiv.className = `absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 p-4 text-center text-3xl font-bold rounded-xl shadow-lg z-20 transition-opacity duration-300`;
            tempDiv.style.backgroundColor = color;
            tempDiv.style.color = '#1a1a2e';
            tempDiv.style.opacity = '1';
            tempDiv.textContent = text;
            
            const gameUi = document.getElementById('game-ui');
            gameUi.appendChild(tempDiv);
            
            messageTimer = setTimeout(() => {
                tempDiv.style.opacity = '0';
                setTimeout(() => tempDiv.remove(), 300);
            }, 1000); // è¨Šæ¯é¡¯ç¤º 1 ç§’
        }

        /**
         * éŠæˆ²ä¸»å¾ªç’°
         */
        function gameLoop(timestamp) {
            if (gameState !== 'playing') return;

            // è™•ç†æ™‚é–“é–“éš”ä»¥ä¿æŒéŠæˆ²æµæš¢
            const deltaTime = timestamp - lastUpdateTime;
            lastUpdateTime = timestamp;

            // 1. æ¸…é™¤ç•«å¸ƒ
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // 2. è™•ç†è¼¸å…¥
            handleInput();

            // 3. æ›´æ–°ç‰©ä»¶
            updateObjects();

            // 4. ç¢°æ’åµæ¸¬
            checkCollisions();

            // 5. ç¹ªè£½ç‰©ä»¶
            drawPlayer();
            bullets.forEach(drawBullet);
            asteroids.forEach(drawAsteroid);
            
            // 6. å°è¡Œæ˜Ÿç”Ÿæˆé‚è¼¯ (æ¯ 2 ç§’)
            if (asteroids.length === 0 && deltaTime > 0) {
                 spawnAsteroids();
            }

            // 7. æª¢æŸ¥éŠæˆ²çµæŸ
            if (lives <= 0) {
                endGame(false);
                return;
            }

            requestAnimationFrame(gameLoop);
        }

        /**
         * ç©å®¶ç™¼å°„å­å½ˆ
         */
        function shoot() {
            if (gameState !== 'playing') return;
            // é™åˆ¶å­å½ˆæ•¸é‡ï¼Œé˜²æ­¢ä½œå¼Šæˆ–å¡é “
            if (bullets.length < 5) { 
                bullets.push({ 
                    x: player.x, 
                    y: CANVAS_HEIGHT - 30 - PLAYER_SIZE / 2, // å¾é£›èˆ¹ä¸Šæ–¹ç™¼å°„
                });
            }
        }

        // --- äº‹ä»¶ç›£è½å™¨ ---

        // æ¡Œé¢éµç›¤æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            if (gameState !== 'playing') return;
            if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') {
                player.movingLeft = true;
            } else if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') {
                player.movingRight = true;
            } else if (e.key === ' ' || e.key === 'Enter') {
                e.preventDefault(); // é˜²æ­¢ç©ºç™½éµæ»¾å‹•é é¢
                shoot();
            }
        });

        document.addEventListener('keyup', (e) => {
            if (gameState !== 'playing') return;
            if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') {
                player.movingLeft = false;
            } else if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') {
                player.movingRight = false;
            }
        });
        
        // è¡Œå‹•è£ç½®è§¸æ§æ§åˆ¶ (æŒ‰ä¸‹)
        mobileLeft.addEventListener('touchstart', (e) => { e.preventDefault(); player.movingLeft = true; });
        mobileRight.addEventListener('touchstart', (e) => { e.preventDefault(); player.movingRight = true; });
        mobileShoot.addEventListener('touchstart', (e) => { e.preventDefault(); shoot(); });

        // è¡Œå‹•è£ç½®è§¸æ§æ§åˆ¶ (æ”¾é–‹)
        mobileLeft.addEventListener('touchend', () => { player.movingLeft = false; });
        mobileRight.addEventListener('touchend', () => { player.movingRight = false; });
        mobileShoot.addEventListener('touchend', () => { /* shoot() åœ¨ touchstart æ™‚å·²è™•ç†ï¼Œé€™è£¡åƒ…ç”¨æ–¼åœæ­¢æŒçºŒå°„æ“Šçš„é‚è¼¯ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰ */ });
        
        // æ»‘é¼ /éµç›¤é»æ“Šé–‹å§‹æŒ‰éˆ•
        startButton.addEventListener('click', initGame);
        
        // ç¢ºä¿åœ¨è¦–çª—è¼‰å…¥å®Œæˆå¾Œé¡¯ç¤ºåˆå§‹ç•«é¢
        window.onload = () => {
             // èª¿æ•´ Canvas å¯¦éš›å¤§å°ä»¥é©æ‡‰å®¹å™¨ï¼Œä¸¦ä¿æŒç¹ªåœ–è§£æåº¦
            canvas.width = CANVAS_WIDTH;
            canvas.height = CANVAS_HEIGHT;
            
            // é¡¯ç¤ºé–‹å§‹ç•«é¢
            startScreen.classList.remove('hidden');
        };

    </script>
</body>
</html>